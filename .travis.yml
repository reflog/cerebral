sudo: required
dist: trusty
language: node_js
node_js: '6'
cache:
  directories:
  - node_modules

before_install: 
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sudo add-apt-repository ppa:ubuntu-wine/ppa -y ;fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF ;fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then echo "deb http://download.mono-project.com/repo/debian wheezy main" | sudo tee /etc/apt/sources.list.d/mono-xamarin.list ;fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sudo apt-get update ;fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sudo apt-get install --no-install-recommends -y wine1.8 mono-devel ca-certificates-mono rpm ;fi

matrix:
  include:
    - os: osx
    - os: linux
      env: CC=clang CXX=clang++ npm_config_clang=1
      compiler: clang

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-4.8
      - icnsutils
      - graphicsmagick
      - libgnome-keyring-dev
      - xz-utils
      - xorriso
      - xvfb

install: true
  
notifications:
  email: false
before_script:
- npm prune
- lerna bootstrap --scope '@(function-tree|cerebral|cerebral-forms|cerebral-provider-http|cerebral-provider-firebase|cerebral-provider-forms|cerebral-router|babel-*)'
- lerna bootstrap --scope @cerebral/codemods*
after_success:
- |
  git remote add auth https://cerebraljs:${GH_TOKEN}@github.com/reflog/cerebral;
  git config --global user.email "cerebraljs@gmail.com";
  git config --global user.name "Cerebral JS";
  if [[ $TRAVIS_BRANCH == 'debugger_autoupdate' && $TRAVIS_PULL_REQUEST == 'false' ]]; then
    # TODO: check changed path to decide if npm publish necessary
    npm run link;
    lerna bootstrap;
    cd debugger;
    npm run build;
    if [[ $TRAVIS_OS_NAME == 'linux' ]]; then
      npm run package:wl;
    fi
    if [[ $TRAVIS_OS_NAME == 'osx' ]]; then
      npm run package:mac;
    fi
  fi
branches:
  except:
  - "/^v\\d+\\.\\d+\\.\\d+$/"
